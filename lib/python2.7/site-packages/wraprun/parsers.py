import argparse
from . import GROUP_OPTIONS, GLOBAL_OPTIONS

class TaskParser(object):
    def __init__(self):
        self._task_parser = argparse.ArgumentParser(add_help=False)
        GROUP_OPTIONS.add_to_parser(self._task_parser)

    def parse_task(self, string):
        arglist = string.split()
        names = self._task_parser.parse_args(arglist)
        args = GROUP_OPTIONS.all_args(names)
        if args['exe'][0] == '--':
            args['exe'].pop(0)
        return args

def create_cli_parser():
    parser = argparse.ArgumentParser(
        add_help=False,
        description='A flexible aprun task bundling tool.')

    global_opts = parser.add_argument_group(
        title='Global Options',
        description='Global options may only occur once and must precede the first task spec.')

    global_opts.add_argument(
        '-h',
        '--help',
        action='help',
        help='Show this help message and exit')

    GLOBAL_OPTIONS.add_to_parser(global_opts)

    task = parser.add_argument_group(
        title='Defining Task Specs',
        description='''A task must have a number of PEs and an executable on Lustre.
        All Wraprun/Aprun options for the task must be given before the executable.
        Ambiguous option errors can be avoided by inserting the
        pseudo-argument '--' prior to the executable string.
        ''')

    GROUP_OPTIONS.add_to_parser(task)

    task_extra = parser.add_argument_group(
        title='Additional Task Specs',
        description='Each additional task spec is separated by " : ". ')
    task_extra.add_argument(
        'other_tasks',
        metavar=' : task',
        nargs="*",
        help="Optional additional tasks")
    return parser

