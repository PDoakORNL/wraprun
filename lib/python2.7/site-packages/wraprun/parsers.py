import argparse
from . import GROUP_OPTIONS, GLOBAL_OPTIONS

class Parsers():
    def __init__(self):
        self._task_parser = argparse.ArgumentParser(add_help=False)
        self._add_args(GROUP_OPTIONS.wraprun, self._task_parser)
        self._add_args(GROUP_OPTIONS.aprun, self._task_parser)

    def _add_args(self, args, parser):
        for i in args:
            i.add_to_parser(parser)

    def parse_task(self, string):
        arglist = string.split()
        names = self._task_parser.parse_args(arglist)
        args = {k:v for k, v in names.__dict__.iteritems() if v is not None}
        if args['exe'][0] == '--':
            args['exe'].pop(0)
        return args

    def cli(self):
        parser = argparse.ArgumentParser(
            add_help=False,
            description='A flexible aprun task bundling tool.')

        global_opts = parser.add_argument_group(
            title='Global Options',
            description='Global options may only occur once and must precede the first task spec.')

        global_opts.add_argument(
                '-h',
                '--help',
                action='help',
                help='Show this help message and exit')

        self._add_args(GLOBAL_OPTIONS.wraprun, global_opts)
        self._add_args(GLOBAL_OPTIONS.aprun, global_opts)

        task = parser.add_argument_group(
                title='Defining Task Specs',
                description='''A task must have a number of PEs and an executable on Lustre.
                All Wraprun/Aprun options for the task must be given before the executable.
                Ambiguous option errors can be avoided by inserting the
                pseudo-argument '--' prior to the executable string.
                ''')

        self._add_args(GROUP_OPTIONS.wraprun, task)
        self._add_args(GROUP_OPTIONS.aprun, task)

        task_extra = parser.add_argument_group(
                title='Additional Task Specs',
                description='Each additional task spec is separated by " : ". ')
        task_extra.add_argument(
                'other_tasks',
                metavar=' : task',
                nargs="*",
                help="Optional additional tasks")
        return parser

